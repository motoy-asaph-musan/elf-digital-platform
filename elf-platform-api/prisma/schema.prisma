generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --- USER & AUTH SECTION ---

model User {
  id             String    @id @default(uuid())
  email          String    @unique
  phone          String?   @unique // Added for AuthService logic
  name           String?
  password       String
  role           Role      @default(STUDENT)
  createdAt      DateTime  @default(now())
  
  // Relations
  studentProfile Student?
  schoolId       String?
  school         School?   @relation("SchoolToUser", fields: [schoolId], references: [id])
  payments       Payment[]
}

enum Role {
  STUDENT
  TEACHER
  ADMIN
  COORDINATOR
}

// --- SCHOOL & SUBSCRIPTION SECTION ---

model School {
  id               String    @id @default(uuid())
  name             String
  address          String
  region           String?   // Central, Eastern, Western, Northern
  contactPhone     String?   
  schoolCode       String?   @unique // The 6-digit access code we generate
  isRegistered     Boolean   @default(false)
  registrationDate DateTime?
  
  // Relations
  user            User[]    @relation("SchoolToUser")
  payments         Payment[]
}

// --- EXAM & CONTENT SECTION ---

model Exam {
  id              String        @id @default(uuid())
  title           String
  description     String?
  durationMinutes Int
  category        ExamCategory
  startTime       DateTime
  endTime         DateTime
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  // Relations
  questions       Question[]
  session        ExamSession[]
}

enum ExamCategory {
  UPPER_PRIMARY
  O_LEVEL
  A_LEVEL
}

model Question {
  id            String       @id @default(uuid())
  text          String       @db.Text
  mediaUrl      String?
  mediaType     String?      // 'IMAGE' or 'VIDEO'
  points        Int          @default(1)
  type          QuestionType @default(MULTIPLE_CHOICE)
  
  options       Json?        // Stores ["A", "B", "C"]
  correctAnswer String

  // Relations
  examId        String
  exam          Exam         @relation(fields: [examId], references: [id], onDelete: Cascade)
  answers       Answer[]
}

enum QuestionType {
  MULTIPLE_CHOICE
  TRUE_FALSE
  SHORT_ANSWER
  ESSAY
}

// --- STUDENT PERFORMANCE SECTION ---

model Student {
  id          String   @id @default(uuid())
  userId      String   @unique
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  grade       String   // e.g. "P.7" or "S.4"
  indexNumber String   @unique
  totalPoints Int      @default(0)
  isEligible  Boolean  @default(true)
  
  // Relations
  session    ExamSession[]
}

model ExamSession {
  id             String           @id @default(uuid())
  examId         String
  exam           Exam             @relation(fields: [examId], references: [id])
  studentId      String
  student        Student          @relation(fields: [studentId], references: [id])
  startedAt      DateTime         @default(now())
  deadlineAt     DateTime
  submittedAt    DateTime?
  status         SessionStatus    @default(IN_PROGRESS)
  score          Int?
  currentAnswers Json?            // Added: To track progress before final submission
  deviceId       String?

  // Relations
  responses      Answer[]

  @@unique([examId, studentId])
}

enum SessionStatus {
  IN_PROGRESS
  SUBMITTED
  EXPIRED
}

model Answer {
  id             String      @id @default(uuid())
  sessionId      String
  session        ExamSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  questionId     String
  question       Question    @relation(fields: [questionId], references: [id])
  value          String      @db.Text
  pointsEarned   Int         @default(0)
  isGraded       Boolean     @default(false)
  teacherComment String?
  createdAt      DateTime    @default(now())

  @@unique([sessionId, questionId])
}

// --- FINANCIAL SECTION ---

model Payment {
  id            String          @id @default(uuid())
  attempts      Int      @default(0)  // Add this line if missing
  amount        Float
  currency      String          @default("UGX")
  purpose       String          // "SCHOOL_REG", "CONTEST_FEE", "DONATION"
  status        PaymentStatus   @default(PENDING)
  provider      PaymentProvider
  reference     String          @unique 
  whatsappRef   String?         
  
  // Relations
  userId        String?
  user          User?           @relation(fields: [userId], references: [id])
  schoolId      String?
  school        School?         @relation(fields: [schoolId], references: [id])
  
  donation      Donation?
  subscription  Subscription?

  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
}

enum PaymentProvider {
  MTN
  AIRTEL
  VISA
  FLUTTERWAVE
  BANK_DEPOSIT
}

enum PaymentStatus {
  PENDING
  SUCCESS
  VERIFIED 
  FAILED
}

model Donation {
  id        String  @id @default(uuid())
  paymentId String  @unique
  payment   Payment @relation(fields: [paymentId], references: [id])
  campaign  String?
  message   String?
}

model Subscription {
  id        String             @id @default(uuid())
  paymentId String             @unique
  payment   Payment            @relation(fields: [paymentId], references: [id])
  plan      String
  startDate DateTime
  endDate   DateTime
  status    SubscriptionStatus @default(ACTIVE)
}

enum SubscriptionStatus {
  ACTIVE
  EXPIRED
  CANCELLED
}